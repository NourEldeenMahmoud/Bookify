@using Bookify.Data.Models
@model Room

<div class="modal fade" id="roomDetailsModal" tabindex="-1" aria-labelledby="roomDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xxl modal-dialog-centered room-details-dialog">
        <div class="modal-content room-details-modal shadow-lg">
            <div class="modal-header border-0 pb-0">
                <div>
                    <h5 class="modal-title fw-semibold" id="roomDetailsModalLabel">
                        @(Model.RoomType?.Name ?? "Room") — Room Details
                    </h5>
                    <p class="text-muted mb-0 small">
                        Room #@Model.RoomNumber · @(Model.RoomType?.MaxOccupancy ?? 1) Guests
                    </p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body pt-3">
                <div class="row g-4 align-items-stretch">
                    <!-- Images / Carousel - 40% -->
                    <div class="col-lg-5 col-md-12">
                        <div id="roomDetailsCarousel" class="carousel slide room-details-carousel" data-bs-ride="carousel">
                            <div class="carousel-inner rounded-4 overflow-hidden position-relative">
                                @{
                                    // Get all images: Priority is GalleryImages, then RoomType.ImageUrl as fallback
                                    var allImages = new List<string>();
                                    
                                    if (Model.GalleryImages != null && Model.GalleryImages.Any())
                                    {
                                        foreach (var img in Model.GalleryImages)
                                        {
                                            if (!string.IsNullOrEmpty(img.ImageUrl))
                                            {
                                                string imagePath;
                                                if (img.ImageUrl.StartsWith("~/"))
                                                {
                                                    imagePath = Url.Content(img.ImageUrl);
                                                }
                                                else if (img.ImageUrl.StartsWith("/"))
                                                {
                                                    imagePath = img.ImageUrl;
                                                }
                                                else
                                                {
                                                    imagePath = Url.Content($"~/images/{img.ImageUrl}");
                                                }
                                                allImages.Add(imagePath);
                                            }
                                        }
                                    }
                                    
                                    // If no gallery images, use RoomType.ImageUrl as fallback
                                    if (!allImages.Any())
                                    {
                                        var fallbackImage = Model.RoomType?.ImageUrl;
                                        if (!string.IsNullOrEmpty(fallbackImage))
                                        {
                                            string fallbackPath;
                                            if (fallbackImage.StartsWith("~/"))
                                            {
                                                fallbackPath = Url.Content(fallbackImage);
                                            }
                                            else if (fallbackImage.StartsWith("/"))
                                            {
                                                fallbackPath = fallbackImage;
                                            }
                                            else
                                            {
                                                fallbackPath = Url.Content($"~/images/{fallbackImage}");
                                            }
                                            allImages.Add(fallbackPath);
                                        }
                                        else
                                        {
                                            allImages.Add(Url.Content("~/images/G1.jpg"));
                                        }
                                    }
                                }
                                
                                @if (allImages.Any())
                                {
                                    @for (int i = 0; i < allImages.Count; i++)
                                    {
                                        <div class="carousel-item @(i == 0 ? "active" : "")">
                                            <img src="@allImages[i]"
                                                 class="d-block w-100"
                                                 alt="@(Model.RoomType?.Name ?? "Room") - Image @(i + 1)"
                                                 loading="lazy"
                                                 style="object-fit: cover;"
                                                 asp-append-version="true" />
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="carousel-item active">
                                        <img src="@Url.Content("~/images/G1.jpg")"
                                             class="d-block w-100"
                                             alt="@(Model.RoomType?.Name ?? "Room")"
                                             loading="lazy"
                                             style="object-fit: cover;"
                                             asp-append-version="true" />
                                    </div>
                                }

                                <!-- Carousel Controls - positioned absolutely -->
                                <button class="carousel-control-prev carousel-control-custom" type="button" data-bs-target="#roomDetailsCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next carousel-control-custom" type="button" data-bs-target="#roomDetailsCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Details - 60% -->
                    <div class="col-lg-7 col-md-12">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="flex-grow-1">
                                <h4 class="fw-semibold mb-2">@Model.RoomType?.Name</h4>
                                <p class="text-muted mb-0">
                                    @(Model.RoomType?.Description ?? "Experience comfort and elegance with our thoughtfully designed room.")
                                </p>
                            </div>
                            <div class="text-end ms-3">
                                <div class="fs-5 fw-bold text-accent-price" style="display: flex; gap: 6px; align-items: center; white-space: nowrap; flex-wrap: nowrap;">
                                    <span>@(Model.RoomType?.PricePerNight.ToString("N0") ?? "0")</span>
                                    <span>EGP</span>
                                    <span class="fs-6 text-muted fw-normal">/ night</span>
                                </div>
                                <div class="small text-muted mt-1">
                                    Max @Model.RoomType?.MaxOccupancy guests
                                </div>
                            </div>
                        </div>

                        <!-- Key facts -->
                        <div class="row g-3 mb-2">
                            <div class="col-6">
                                <div class="info-pill">
                                    <i class="fa-solid fa-users me-2 icon-accent"></i>
                                    <span>@(Model.RoomType?.MaxOccupancy ?? 1) Guests</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="info-pill">
                                    <i class="fa-solid fa-square me-2 icon-accent"></i>
                                    <span>35 m²</span>
                                </div>
                            </div>
                        </div>
                        <div class="small text-muted mb-4">
                            Max @Model.RoomType?.MaxOccupancy guests
                        </div>

                        <!-- Base amenities based on RoomType -->
                        @{
                            var baseServices = new List<string>();
                            var typeName = Model.RoomType?.Name?.ToLower() ?? string.Empty;

                            if (typeName.Contains("suite"))
                            {
                                baseServices = new List<string> { "Cleaning", "Open Buffet" };
                            }
                            else if (typeName.Contains("deluxe"))
                            {
                                baseServices = new List<string> { "Breakfast", "Airport Pickup" };
                            }
                            else // standard / others
                            {
                                baseServices = new List<string> { "WiFi", "Breakfast" };
                            }
                        }

                        <div class="mb-4 mt-4">
                            <h6 class="fw-semibold mb-2">Included Services</h6>
                            <div class="d-flex flex-wrap gap-2">
                                @foreach (var service in baseServices)
                                {
                                    <span class="badge rounded-pill included-service-pill">
                                        <i class="fa-solid fa-check me-1"></i>@service
                                    </span>
                                }
                            </div>
                        </div>

                        <!-- Generic amenities -->
                        <div class="mb-4 mt-4">
                            <h6 class="fw-semibold mb-2">Amenities</h6>
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge rounded-pill amenity-pill">Free WiFi</span>
                                <span class="badge rounded-pill amenity-pill">Flat-screen TV</span>
                                <span class="badge rounded-pill amenity-pill">Air Conditioning</span>
                                <span class="badge rounded-pill amenity-pill">Mini Bar</span>
                                <span class="badge rounded-pill amenity-pill">Room Service</span>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="d-flex flex-wrap gap-2 justify-content-start align-items-center mt-4">
                            <button type="button" class="btn px-4 py-2 add-to-cart-btn" 
                                    data-room-id="@Model.Id"
                                    data-room-number="@Model.RoomNumber"
                                    data-room-type-name="@(Model.RoomType?.Name ?? "")"
                                    data-price-per-night="@(Model.RoomType?.PricePerNight ?? 0)"
                                    data-max-occupancy="@(Model.RoomType?.MaxOccupancy ?? 1)"
                                    data-image-url="@(Model.GalleryImages?.FirstOrDefault()?.ImageUrl ?? Model.RoomType?.ImageUrl ?? "~/images/G1.jpg")"
                                    data-description="@(Model.RoomType?.Description ?? "")"
                                    style="background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%); color: #fff; border: none; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);">
                                <i class="fas fa-cart-plus me-2"></i>Add to Cart
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .room-details-dialog {
        max-width: 1100px;
    }

    .room-details-modal {
        border-radius: 24px;
        border: none;
        overflow-y: auto;
        max-height: 90vh;
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f7f4ef;
    }

    .room-details-modal .modal-header {
        padding: 1.5rem 1.75rem 0.5rem;
    }

    .room-details-modal .modal-body {
        padding: 1.5rem 1.75rem 1.75rem;
    }

    .room-details-carousel {
        position: relative;
    }

    .room-details-carousel img {
        height: 400px;
        object-fit: cover;
        border-radius: 18px;
        width: 100%;
        max-width: 100%;
        display: block;
    }

    .room-details-carousel .carousel-inner {
        border-radius: 18px;
        overflow: hidden;
    }

    .carousel-control-custom {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 45px;
        height: 45px;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        opacity: 0.8;
        z-index: 10;
    }

    .carousel-control-custom:hover {
        opacity: 1;
        background-color: rgba(255, 255, 255, 1);
    }

    .carousel-control-prev.carousel-control-custom {
        left: 15px;
    }

    .carousel-control-next.carousel-control-custom {
        right: 15px;
    }

    .carousel-control-custom .carousel-control-prev-icon,
    .carousel-control-custom .carousel-control-next-icon {
        filter: invert(1);
    }

    .info-pill {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 0.9rem;
        border-radius: 999px;
        background-color: #fff8f0;
        border: 1px solid rgba(255, 140, 66, 0.35);
        font-size: 0.85rem;
        color: #3b2c2c;
        width: 100%;
        justify-content: center;
    }

    .icon-accent {
        color: #b45309;
    }

    .included-service-pill {
        background-color: #d1fae5 !important;
        color: #065f46 !important;
        border: 1px solid #6ee7b7 !important;
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }

    .amenity-pill {
        background-color: #f3f4f6 !important;
        color: #4b5563 !important;
        border: 1px solid #d1d5db !important;
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }

    .text-accent-price {
        color: #ea580c;
    }

    .add-to-cart-btn:hover {
        background: linear-gradient(135deg, #ea580c 0%, #d97706 100%) !important;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5) !important;
    }

    .add-to-cart-btn:active {
        transform: translateY(0);
    }

    .btn-primary {
        background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
        border: none;
        font-weight: 600;
        font-size: 16px;
        border-radius: 12px;
        padding: 0.75rem 2rem;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
    }

    @@media (max-width: 768px) {
        .room-details-carousel img {
            height: 280px;
            max-width: 100%;
        }

        .room-details-dialog {
            max-width: 95%;
            margin: 1rem auto;
        }

        .room-details-modal {
            max-height: 95vh;
            margin: 0.5rem;
        }

        .col-lg-5,
        .col-lg-7 {
            width: 100%;
            margin-bottom: 1rem;
        }

        .info-pill {
            font-size: 0.8rem;
            padding: 0.4rem 0.7rem;
        }

        .btn-primary {
            width: 100%;
            font-size: 15px;
        }
    }
</style>

@if (User.Identity?.IsAuthenticated == true)
{
    <script src="~/js/cart.js" asp-append-version="true"></script>
    <script>
        // Add to cart button handler - must be outside DOMContentLoaded for AJAX-loaded content
        // Use event delegation that works even when modal is loaded dynamically
        (function() {
            // Remove any existing handlers first to prevent duplicates
            $(document).off('click', '.add-to-cart-btn');
            
            // Add new handler using event delegation
            $(document).on('click', '.add-to-cart-btn', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('Add to cart button clicked in modal');
                
                const btnElement = this;
                const originalText = btnElement.innerHTML;
                const originalStyle = btnElement.style.cssText;
                btnElement.disabled = true;
                btnElement.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adding...';
                
                const roomId = parseInt(btnElement.dataset.roomId);
                const maxOccupancy = parseInt(btnElement.dataset.maxOccupancy);
                
                console.log('Room ID:', roomId, 'Max Occupancy:', maxOccupancy);
                
                if (!roomId || isNaN(roomId)) {
                    alert('Invalid room ID. Please try again.');
                    btnElement.disabled = false;
                    btnElement.innerHTML = originalText;
                    btnElement.style.cssText = originalStyle;
                    return;
                }
                
                const checkInDate = new Date();
                checkInDate.setDate(checkInDate.getDate() + 1);
                const checkOutDate = new Date(checkInDate);
                checkOutDate.setDate(checkOutDate.getDate() + 1);

                const requestData = {
                    roomId: roomId,
                    checkIn: checkInDate.toISOString().split('T')[0],
                    checkOut: checkOutDate.toISOString().split('T')[0],
                    numberOfGuests: maxOccupancy || 1
                };

                console.log('Adding to cart:', requestData);
                console.log('URL:', '@Url.Action("Add", "Cart")');

                $.ajax({
                    url: '@Url.Action("Add", "Cart")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(requestData),
                    success: function(data) {
                        console.log('Add to cart response:', data);
                        
                        if (data && data.success) {
                            // Update cart badge
                            if (typeof window.cartManager !== 'undefined' && window.cartManager.updateCartBadge) {
                                window.cartManager.updateCartBadge();
                            }
                            
                            // Show success message
                            btnElement.innerHTML = '<i class="fas fa-check me-2"></i>Added!';
                            btnElement.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                            
                            // Close modal if open
                            const modalElement = document.getElementById('roomDetailsModal');
                            if (modalElement) {
                                const modal = bootstrap.Modal.getInstance(modalElement);
                                if (modal) {
                                    setTimeout(() => {
                                        modal.hide();
                                    }, 500);
                                }
                            }
                            
                            // Redirect to cart page after a short delay
                            setTimeout(() => {
                                window.location.href = '@Url.Action("Index", "Cart")';
                            }, 1000);
                        } else {
                            const errorMsg = (data && data.error) ? data.error : 'Failed to add room to cart';
                            btnElement.disabled = false;
                            btnElement.innerHTML = originalText;
                            btnElement.style.cssText = originalStyle;
                            alert(errorMsg);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX Error:', xhr, status, error);
                        console.error('Response:', xhr.responseText);
                        let errorMessage = 'Failed to add room to cart';
                        
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMessage = xhr.responseJSON.error;
                        } else if (xhr.responseText) {
                            try {
                                const errorData = JSON.parse(xhr.responseText);
                                errorMessage = errorData.error || errorMessage;
                            } catch (e) {
                                errorMessage = xhr.responseText.substring(0, 100);
                            }
                        }
                        
                        btnElement.disabled = false;
                        btnElement.innerHTML = originalText;
                        btnElement.style.cssText = originalStyle;
                        alert(errorMessage);
                    }
                });
            });
        })();
    </script>
}

@using Bookify.Data.Models
@model IEnumerable<Room>

@functions {
    string GetFallbackImage(string? roomTypeImageUrl)
    {
        if (!string.IsNullOrEmpty(roomTypeImageUrl))
        {
            if (roomTypeImageUrl.StartsWith("~/"))
            {
                return Url.Content(roomTypeImageUrl);
            }
            else if (roomTypeImageUrl.StartsWith("/"))
            {
                return roomTypeImageUrl;
            }
            else
            {
                return Url.Content($"~/images/{roomTypeImageUrl}");
            }
        }
        return Url.Content("~/images/G1.jpg");
    }
}

<style>
    .view-cart-btn {
        background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%) !important;
        color: #fff !important;
        border: none !important;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4) !important;
    }
    
    .view-cart-btn:hover {
        background: linear-gradient(135deg, #ea580c 0%, #d97706 100%) !important;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5) !important;
    }
    
    .view-cart-btn:active,
    .view-cart-btn:focus,
    .view-cart-btn:visited {
        background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%) !important;
        color: #fff !important;
        border: none !important;
    }
</style>

<!-- Rooms Section -->
<section id="rooms" class="rooms-section py-5">
  <div class="container">
    @if (ViewBag.HideTitle != true)
    {
    <div class="text-center mb-5">
      <h2 class="section-title">Our Rooms and Suites</h2>
      <p class="section-subtitle">
        Discover elegantly designed accommodations that blend comfort with sophistication
      </p>
    </div>
    }
    
    @if (User.Identity?.IsAuthenticated == true)
    {
        <!-- Cart Link -->
        <div class="d-flex justify-content-end mb-4">
            <a href="@Url.Action("Index", "Cart")" class="btn position-relative view-cart-btn" style="background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%); color: #fff; border: none; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);">
                <i class="fas fa-cart-shopping me-2"></i>
                <span>View Cart</span>
                <span class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle cart-badge" id="cartBadge" style="display: none; font-size: 0.6rem; padding: 0.2rem 0.4rem;">0</span>
            </a>
        </div>
    }

    <!-- Rooms Container -->
    <div class="row" id="rooms-container" style="margin: 0 -12px;">
      @if (Model != null && Model.Any())
      {
          @foreach (var room in Model)
          {
              <div class="col-lg-3 col-md-6 col-sm-12" style="padding: 0 12px; margin-bottom: 24px;">
                <div class="room-card">
                  <div class="room-img">
                    @{
                        string roomImagePath;
                        // Priority: Use first image from GalleryImages, then RoomType.ImageUrl, then default
                        if (room.GalleryImages != null && room.GalleryImages.Any())
                        {
                            var galleryImg = room.GalleryImages.First().ImageUrl;
                            if (!string.IsNullOrEmpty(galleryImg))
                            {
                                if (galleryImg.StartsWith("~/"))
                                {
                                    roomImagePath = Url.Content(galleryImg);
                                }
                                else if (galleryImg.StartsWith("/"))
                                {
                                    roomImagePath = galleryImg;
                                }
                                else
                                {
                                    roomImagePath = Url.Content($"~/images/{galleryImg}");
                                }
                            }
                            else
                            {
                                roomImagePath = GetFallbackImage(room.RoomType?.ImageUrl);
                            }
                        }
                        else
                        {
                            roomImagePath = GetFallbackImage(room.RoomType?.ImageUrl);
                        }
                    }
                    <img src="@roomImagePath" alt="@room.RoomType?.Name" class="w-100" style="object-fit: cover; height: 250px;" loading="lazy" decoding="async" asp-append-version="true">
                    <div class="price-badge">
                        @($"{room.RoomType?.PricePerNight.ToString("N0")} EGP per night")
                    </div>
                  </div>
                  <div class="room-info">
                    <h3 class="room-title">@room.RoomType?.Name</h3>
                    <div class="room-details">
                      <span class="room-detail-item">
                        <i class="fa-solid fa-users"></i>
                        @(room.RoomType?.MaxOccupancy ?? 1) Guests
                      </span>
                      <span class="room-detail-item">
                        <i class="fa-solid fa-square"></i>
                        35 mÂ²
                      </span>
                    </div>
                    <div class="room-amenities">
                      <span class="amenity-tag">WiFi</span>
                      <span class="amenity-tag">Breakfast</span>
                      <span class="amenity-tag">TV</span>
                      <span class="amenity-tag">AC</span>
                    </div>
                    <div class="d-flex gap-2">
                      <button type="button"
                              class="book-now-btn view-room-details-btn flex-grow-1"
                              data-room-id="@room.Id">
                        View Details
                      </button>
                      @if (User.Identity?.IsAuthenticated == true)
                      {
                          <button type="button"
                                  class="btn add-to-cart-quick-btn"
                                  data-room-id="@room.Id"
                                  data-room-number="@room.RoomNumber"
                                  data-room-type-name="@(room.RoomType?.Name ?? "")"
                                  data-price-per-night="@(room.RoomType?.PricePerNight ?? 0)"
                                  data-max-occupancy="@(room.RoomType?.MaxOccupancy ?? 1)"
                                  data-image-url="@(room.GalleryImages?.FirstOrDefault()?.ImageUrl ?? room.RoomType?.ImageUrl ?? "~/images/G1.jpg")"
                                  data-description="@(room.RoomType?.Description ?? "")"
                                  title="Add to Cart"
                                  style="background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%); color: #fff; border: none; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);">
                            <i class="fas fa-cart-plus"></i>
                          </button>
                      }
                    </div>
                  </div>
                </div>
              </div>
          }
      }
      else
      {
          <div class="col-12 text-center">
            <p class="text-muted">No available rooms at the moment.</p>
          </div>
      }
    </div>

    <!-- Pagination -->
    @if (ViewBag.TotalPages > 1)
    {
        <div class="pagination-container mt-5">
          <nav aria-label="Rooms pagination">
            <ul class="pagination justify-content-center" id="rooms-pagination">
              @if (ViewBag.CurrentPage > 1)
              {
                  <li class="page-item">
                    <a class="page-link pagination-link" href="#" data-page="@(ViewBag.CurrentPage - 1)">Previous</a>
                  </li>
              }
              
              @for (int i = 1; i <= ViewBag.TotalPages; i++)
              {
                  if (i == ViewBag.CurrentPage)
                  {
                      <li class="page-item active">
                        <span class="page-link">@i</span>
                      </li>
                  }
                  else
                  {
                      <li class="page-item">
                        <a class="page-link pagination-link" href="#" data-page="@i">@i</a>
                      </li>
                  }
              }
              
              @if (ViewBag.CurrentPage < ViewBag.TotalPages)
              {
                  <li class="page-item">
                    <a class="page-link pagination-link" href="#" data-page="@(ViewBag.CurrentPage + 1)">Next</a>
                  </li>
              }
            </ul>
          </nav>
        </div>
    }
  </div>
</section>
